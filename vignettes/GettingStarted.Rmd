---
title: "Getting Started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: sentence
---

# Introduction

We originally set out to harmonize these biomonitoring datasets from the USGS and USEPA during the COVID-19 pandemic, spending countless hours coding from home offices, basements, couches, kitchen tables, etc.
The code within these functions represents many Zoom meetings with U.S. federal researchers with the most intimate knowledge of the data as well as sample collection, processing, and identification.
We hope that we have done justice to these data; the organisms that were collected; the countless biologists that collected, processed, and identified them; and the U.S. public that paid for their collection.
From the conversations with those most familiar with these datasets, we believe we have harmonized these datasets in the most appropriate manner, accounting for as many confounding variables as possible.
The `AquaBioJoinR/FishInvertR/FishInvertRus/DataQuarium/FishInSites/FInvertR/FishBugR` package saves users the time and effort of complex data management, while providing a one-stop tool for generating a unified dataset that contains two aquatic biomonitoring datasets that are unrivaled in their spatio-temporal coverage and consistency in sampling methodologies.
Our ultimate goal for this package is to make these unrivaled data more accessible to researchers across the globe.
The package could streamline the process of retrieving and working with biomonitoring datasets, making it easier for researchers to utilize these data.
We have done our best to ensure a wide-range of uses and standard data types generated by these functions.
We welcome suggests for how to improve accessibility.

```{r setup}
##Read in the StreamData R package
library(StreamData)
```

# Biotic Datasets

### Invertebrates

Currently, there are two groups of functions in the `StreamData` R package.
The first group is the *Biotic Datasets* group of functions: `getInvertData()` and `getFishData()`.
The functions are similar in their parameters, but each has unique aspects that users should be aware of.

Starting with the `getInvertData()` function.
This function retrieves, cleans, and compiles the stream macro-invertebrate datasets collected by the USGS and USEPA.
This function corrects for differences in sample splitting that varied by sampling and identification methods, as well as changes in taxonomy through time.

The parameters in the `getInvertData()` function are `dataType`, `taxonLevel`, `taxonFix`, `agency`, `lifestage`, `rarefy`, `sharedTaxa`, `seed` and `boatableStreams`.
`dataType` refers to whether the site by taxa matrix should contain abundance (`dataType = "abun"`) or presence/absence (coded as 1/0; `dataType = "occur"`) values.

`taxonLevel` refers to the taxonomic resolution (Class, Family, etc.) at which the site by taxa matrix will be generated.
These values must start with a capital letter.
To ensure compatibility among USGS and EPA datasets, as well as to minimize variation among taxonomists, `"Genus"` is the finest taxonomic resolution available.

`taxonFix` provides ways to handle changes in taxonomy across time, especially in instances in which species have been reorganized into new genera.
Across the time span of these datasets, the taxonomy of many species changed.
In cases in which a specimen was identified to species, we were able to update the genus designation from the bench identification to the now used genus names.
In other cases, a given specimen was only identified to genus at the bench, and only some species within the given genus were moved into a new genus.
This scenario prevented us from being confident in the identity of the current genus of the given specimen.
In other cases, a specimen was identified at the bench with multiple species or genera names (e.g., species1/species2 or genus1/genus2).
Some instances of combined genera names were not consistent between EPA and USGS.
Therefore, USGS could contain a specimen identified as genus1/genus2, while EPA included instances of separate identifications of genus1 and genus2.
To ensure consistency between the programs, we renamed all single instances of genus1 and genus2 to genus1/genus2 throughout the combined EPA and USGS dataset.
Here, we provide three options for addressing the taxonomic issues present in the USGS and EPA invertebrate datasets.

`taxonFix` operates on the genera level, so set `taxonFix = "none"` when `taxonLevel` is set to `"Subfamily"` or higher taxonomic resolution.
`taxonFix = "none"` makes no adjustment.
`taxonFix = "none"`, still generate "slash" genera, but, it does not link these genera to larger linked genera (see below).
**We only recommend using this approach when `taxonLevel` is not** `"Genus"`.

`taxonFix = "lump"` prioritizes retaining observations of specimens by giving a unified name (e.g., genus1/genus2/genus3) to a complex of genera that have been linked through changes in taxonomy through time.
With this approach, there is no inflation of the number of genera given that individual genera (e.g., genus1) never appeared outside of the unified genera name (e.g., genus1/genus2/genus3).
Within the combined EPA and USGS datasets, 98 genera exist that are linked through changes in taxonomy through time.
All "non-problematic" genera are retained.
`taxonFix = "lump"` results in 13 "lumped" genera (see Figure 1 below).
Most new "lumped" genera are 2 "old" genera joined.
One complex of genera (within Ephemeroptera) includes 70 "old" genera, and a second complex of Ephemeroptera genera included six individual genera.
`taxonFix = "lump"` was used for analyses in [Rumschlag et al. (2023)](https://doi.org/10.1126/sciadv.adf4896)).

`taxonFix = "remove"` prioritizes accurate identification by dropping observations from problematic genera that do not have species identification.
`taxonFix = "remove"` still prioritizes accurate identifications by dropping all obscure identifications, such that **ALL** slash genera and genera complexes are dropped; this will result in many fewer genera being included in the final dataset, but is the most conservative approach if accuracy in identifications is of high priority.

![**Figure 1.** Visualization of the relationship among linked genera (each number represents an individual genera in the original datasets). Linkages indicate that the taxonomic designation of at least one species from one of the genera pairs was updated to be in the other genera in the pair. Clusters (genera complexes) are formed by sets of these linkages. The largest genera complex represented 70 Ephemeroptera genera.](https://github.com/mahonmb/Misc/blob/main/Clusters.jpg?raw=true){width="275"}

`agency`refers to the agency that collected the datasets, we recommend keeping this set to the default of `c("USGS", "EPA")`, because this will result in the largest dataset, but users should be aware that the sampling design from each agency is quite different.
Specifically, sampling locations in the USGS dataset were constrained by region and/or surrounding landuse, but the USGS dataset provides the sampling locations with the longest duration of collection.
Conversely, sampling locations in the EPA datasets are chosen randomly, but are only collected in two-year phases with 4 years between phases.Users should familiarize themselves with the sampling manuals from each of the agencies: [USGS NAWQA](https://pubs.usgs.gov/publication/ofr93406) and [EPA NRSA](https://www.epa.gov/national-aquatic-resource-surveys/manuals-used-national-aquatic-resource-surveys#National%20Rivers%20&%20Streams%20Assessment). Finally, all USGS sampling locations are considered wadeable streams, while EPA samples both wadeable streams and boatable rivers.
As such, `boatableStreams` should only be `TRUE` when `agency` is set to `"EPA"` only, to ensure the highest level comparability/compatibility between the two agency datasets.

`rarefy` refers to whether samples should be rarefied to 300 individuals to obtain species richness values that are not biased based on the number of individuals identified within a sample (See Figure 2 below, taken from [Rumschlag et al. (2023)](https://doi.org/10.1126/sciadv.adf4896)).
When `rarefy = TRUE`, only samples with 300+ individuals identified will be retained.
Thus, \~17% of samples will be removed, as they have \<300 individuals sampled.
We set the rarefaction threshold at 300, because 1) with every 50 individuals identified, \~1 genera are added to the sample and 2) 82.8% of samples have at least 300 individuals identified.
Thus, lowering the threshold to 200 individuals removed \~2 genera per sample, but only added an additional 7.3% of samples included (90.1% from 82.8%).
Similarly, increasing the threshold to 400 individuals added \~2 genera per sample, but reduced samples to 30.3% of all samples.

![**Figure 2.** Visualization of the relationship between mean number of genera gains, the proportion of samples with at least n number of organisms identified, and the number of organisms identified er sample, justifying the use of 300 as the rarefication threshold.](https://github.com/mahonmb/Misc/blob/main/SciAdvFigS3.jpg?raw=true){width="275"}

Because target specimen (i.e., number of specimen to be identified at the bench) varies across programs, agencies, time, and space, it is necessary to use `rarefy = TRUE` when calculating diversity metrics from these datasets, in order to better account for differences among samples driven by differences in the raw number of individuals identified within a sample.
Use `seed =` and provide an integer to get consistent output of community data (passed to `set.seed()` internally).
`rarefy = TRUE` can be used when wanting occurrence data (presence/absence) OR proportional data (each taxon represents a certain percent of a sample).
To generate density values, use `dataType = "abun"` with `rarefy = FALSE`.

`lifestage` refers to whether the generated site by taxa matrix should include lifestage information for each of the taxa/individuals collected.
If `lifestage = TRUE`, the generated matrix will have separate columns for the various lifestages collected for each taxa.
Lifestage is only noted within the USGS datasets, but not within the EPA datasets.

`sharedTaxa` refers to whether the resulting dataset should only contain taxa that are found in both agency datasets.
Set `sharedTaxa = FALSE` if only using data from one agency.
We recommend using `sharedTaxa = TRUE` when comparing across agencies, so that species pools are consistent.

```{r Invertebrates}

##This code will generate density estimates at the family level for all samples
##in the NAWQA database. Lifestage information will be ignored.

Inverts <- getInvertData(dataType = "occur",
                         taxonLevel = "Genus",
                         agency = "USGS",
                         lifestage = FALSE,
                         rarefy = TRUE,
                         seed = 1)

head(Inverts)[,1:35]

```

### Using the invertebrate data

The resulting invertebrate data will include covariates that are important to clarifying patterns within these data.
The covariates of particular interest to users that will use density data are proportion of sample identified (`propID`) and area sampled (`AreaSampledTotal_m`).
Proportion of the sample identified (`propID`) represented the proportion of the sample collected in the field that was actually identified at the lab bench.
For the USGS dataset, this incorporates both "field split ratio" (proportion of the sample that was brought into the lab for specimen identification) and the "lab subsampling ratio" (proportion of grids used to identify invertebrates at the lab bench).
While for the EPA datasets, this is just the "lab subsampling ratio" the proportion of grids used to identify invertebrates at the lab bench.
See Figure 3 below for visual representation of the `propID` variable.
When conducting density analyses, it is important to use `propID` as a covariate when possible, as `propID` varies across space and time, as well as between agencies.

![**Figure 3**. Calculation of proportion sample identified for USGS and EPA samples. Field split ratio is the proportion of the field collected sample that was brought into the lab to be identified; note that only the USGS data included field split ratios. Lab subsampling ratio is the proportion of grids used to identify invertebrates at the lab bench.](https://github.com/mahonmb/Misc/blob/main/InvertAbun.jpg?raw=true){width="352"}

OTHER STUFF ABOUT USING THE INVERT DATA????
- taxonomic improvements through time?

### Fish

The second function in the *Biotic Datasets* group of functions is `getFishData()`.
This function retrieves, cleans, and compiles the stream fish datasets from the USGS and USEPA.
Because there were differences in how fish were sampled (e.g., netting, electroshocking, and snorkeling), sampling methodologies are retained, as it is difficult to combine samples from these disparate methods.
However, we provide for the standardization of abundances within sample methods (individuals per unit effort per meter of stream sampled).
In the future, we plan to implement a multigear mean standardization , which will allow for the joining of samples taken with disparate methods into a single sample per site.

Fish species names have been updated, such that species with current and synonymous names in the datasets are combined as the current scientific name.

The parameters in the `getFishData()` function are `dataType`, `taxonLevel`, `agency`, `standardize`, `hybrids`, and `boatableStreams`.
`dataType` refers to whether the site by taxa matrix should contain abundance (`dataType = "abun"`) or presence/absence (coded as 1/0; `dataType = "occur"`) values.

`taxonLevel` refers to the taxonomic resolution (Class, Family, Species, etc.) at which the site by taxa matrix will be generated.
These values must start with a capital letter.
Currently, this function will only provide species-level information and all taxonomic grouping must be done by the user outside of the function.

`agency`refers to the agency that collected the datasets, we recommend keeping this set to the default of `c("USGS", "EPA")`, because this will result in the largest dataset.
Users should be aware that the sampling schemes are different between agencies.
Specifically, sampling locations in the USGS dataset were constrained by region and/or surrounding landuse, but the USGS dataset provides the sampling locations with the longest duration of collection.
Conversely, sampling locations in the EPA datasets are chosen randomly, but are only collected in two-year phases with 4 years between phases.

`standardize` refers to whether the abundance values in the site by taxa matrix should be standardized by unit effort (individuals per unit effort per meter sampled).
Specifically, `standardize = CPUE` results in abundances that are divided by the seconds shocked, number of seine hauls, etc.
These values are then divided by the stream length sampled.
When `standardize = MGMS`, abundances are standardized as in `CPUE`, then mean total CPUE (summation of CPUEs for all taxa at each site for each collection date) is calculated for each sampling method.
Then each CPUE value is divided by the mean total CPUE by the mean total CPUE for their respective sampling methods.
`MGMS` will have only one row for each time-location because the function standardizes by sampling method in addition to area sampled, meaning that the resulting abundance values will be summed between sampling methods for each time-location sampling event.
See the supplement of [Gibson-Reinemer et al. (2017)](https://doi.org/10.1139/cjfas-2016-0003) for an example of MGMS computation.
It is highly recommended that users set `standardize` to either `CPUE` or `MGMS` if they are interested in comparing abundance values across sites.
Note: \~35 samples lacked the required standardization information.
Therefore, if you are interested in occurrence (presence/absence) data only, set `standardize = FALSE` and `dataType = "occur"`.
Users should be aware that setting `standardize = "none"` will result in a larger dataset with additional samples/sites than when `standardize = CPUE` or `standardize = "MGMS"`.

`hybrid` refers to whether the output dataset should include fish identified as hybrids between two species.
From conversations with fish experts, we recommend keeping this set to the default of `hybrid = FALSE`, as hybrids are notoriously difficult to identify and may not equate to unique species.

Finally, `boatableStreams` refers to whether boatable streams should be included in the EPA dataset.
Since all USGS sites are coded as "wadeable", `boatableStreams` should only be `TRUE` when `agency` is set to `"EPA"` only to ensure the highest level comparability/compatibility between the two agency datasets.

```{r Fish}

##This code will generate density estimates at the family level for all samples
##in the NAWQA database.

Fish <- getFishData(dataType = "occur",
                    taxonLevel = "Species",
                    agency = c("USGS"),
                    standardize = "none",
                    hybrids = FALSE,
                    boatableStreams = FALSE)

head(Fish)[,1:35]

```

### Using the fish data

The resulting invertebrate data will include information on both reach length fished (`re`), the sampling method employed (e.g., electrochocking, seining, snorkelling; `re`), standardized effort values (e.g., minutes of shocking, number of seine hauls, minutes snorkeling; `re`), and specific protocol employed (e.g., NRSA small stream, NRSA large stream, etc.; `re`).
Users should note that conductivity can influence efficiency of electroshocking (e.g., [Lyon et al. 2014](https://cdnsciencepub.com/doi/10.1139/cjfas-2013-0287)), so, conductivity may be an important covariate to account for when using the electroshocking data, as conductivity likely has large ranges among sites within these datasets.

# Abiotic Datasets

### Pesticide Data

Another function in the `StreamData` package is `getCountyPest()`, which provides access to county-level pesticide use estimates for user-specified sites and years.
This function returns a site by year dataframe of county-level pesticides use estimates in kilograms.

The parameters in `getCountyPest()` are `data`, `ePest`, `lagTime`, `lagType`, `pestLevel`, and `pestLevelName`.
`data` is a user-provided dataset that needs to have two columns: `SiteNumber` and `CollectionYear`.
The site numbers need to be those found in the USGS/NWIS data and must have a `"USGS-"` prefix.
Be aware that there are leading zeros in the USGS/NWIS site numbers, these must be present.
`ePest` refers to the pesticide use estimate: `"low"` or `"high"`.
`lagTime` refers to the number of years over which the pesticide use estimates should be summarized.
`0` returns pesticide use estimates in the given year(s) only.
`lagType` specifies whether to take a `"sum"` or a `"mean"` over years.
Can only be used if `lagTime` is greater than 0.
`pestLevel` specifies whether to summarize pesticide use estimates according to `"type"`, `"class"`, or `"compound"`.
`pestLevelName` specifies the names of the pesticide types, classes, or individual compounds.
A list of types, classes, and individual compounds can be found in an internal dataset: `StreamData:::.pest.info`.

Note: Not every county has an estimate for each of the 483 pesticides in every year.
We have set `na.rm = TRUE` when means and sums are calculated, so we inherently assume use is 0 when not provided.
Seed coats including many neonicotinoids are not included in pesticide use estimates.
Pesticide use estimates are based on agriculture alone.

```{r Pesticide Estimate}

## from site number "05276005" from 1997-1999 (2 year lag) for "insecticide",
## "herbicide", and "synthetic_fungicide".

dat1 <- data.frame(SiteNumber = "USGS-05276005",
                 CollectionYear = 1999)

getCountyPest(data=dat1,
              ePest = "high",
              lagType = "sum",
              lagTime = 2,
              pestLevel = "type",
              pestLevelName = c("insecticide",
                                "herbicide",
                                "synthetic_fungicide"))


## from site number "05276005" for 1999 and 2010 for "insecticide",
## "herbicide", and "synthetic_fungicide".

dat2 <- data.frame(SiteNumber = c("USGS-05276005",
                                  "USGS-05276005"), 
                 CollectionYear = c(1999,
                                    2010))

getCountyPest(data=dat2,
              ePest = "low",
              lagType = "sum",
              lagTime = 0,
              pestLevel = "type",
              pestLevelName = c("insecticide",
                                "herbicide",
                                "synthetic_fungicide"))
  

## See what compounds, classes, and types of pesticides are available.
pestinfo <- StreamData:::.pest.info
head(pestinfo)

```

### NLCD Land use/Land cover Data

Another function in the `StreamData` package is `getNLCDData()`, which provides access to catchment-and watershed-level NLCD land use/land cover datasets.
Land-use/land-cover data is extracted from the USGS National Land Cover Database (NLCD) and was generated from StreamCat ([Hill et al. 2015](https://onlinelibrary.wiley.com/doi/full/10.1111/1752-1688.12372)).
This function pulls from internally stored data, rather than pinging the StreamCat database, in an effort to speed up data access.
LULC data are available in the following years: 2001, 2004, 2006, 2008, 2011, 2013, 2016, and 2019.
For instances of years in the input data that are not exact year matches from this list, years are temporally matched to the closest year with LULC data (e.g. a site sampled in 1995 will have LULC data from 2001).
Note that for samples that fall at the midpoint of two NLCD years (e.g. 2005), the function defaults to the earlier year (e.g. a site sampled in 2005 will have LULC data from 2004).

Data can be extracted at the catchment `Cat` or watershed `Ws` scales.
Watershed is larger than catchment, and includes land that drains downstream of the sampling location.
Catchment only includes land that is upstream of the sampling location.
See [StreamCat](https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset) documentation for more information.

LULC data can be grouped `group = TRUE` into five broad categories.
These categories include "water" (grouping of all wetland and open water land covers), "urban" (grouping of all urban land use), "forest" (grouping of deciduous, coniferous, and mixed forests land covers), "open" (grouping of shrub, barren land, grassland, and hay/pasture land covers), and "crop" (no grouping, just the crop land use).

```{r Land use/Land cover}
dat = data.frame(SiteNumber = "USGS-05276005",
                 CollectionYear = c(2005, 2007, 2009))

getNLCDData(data=dat,
            scale = "Cat",
            group = FALSE)

```

## Parting words

For metadata on output datasets, check out the "Metadata" vignette (`vignettes("Metadata")`).

R packages are not static and require regular tweaking and maintenance, so regular updates will occur.
Furthermore, the EPA NRSA program continues to sample rivers and streams throughout the contiguous US and we intend to incorporate each new round of NRSA sampling into this R package as soon as the newest data are made public.
So, the \~30 year time-span of this dataset will only grow as the EPA continues to conduct sampling.

We are completely indebted to the countless biologists who collected the invertebrate and fish samples in the field, who processed and identified samples, and who oversee these collection programs and thank them for their efforts.

If you have any questions or any issues with these functions, please post on our Github repository [Github]() reach out to Samantha Rumschlag ([rumschlag.samantha\@epa.gov](mailto:rumschlag.samantha@epa.gov){.email}) or Michael Mahon ([m](mailto:mmahon4@nd.edu){.email}[mahon.michael\@epa.gov](mailto:mahon.michael@epa.gov){.email}).
