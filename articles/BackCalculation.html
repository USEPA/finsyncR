<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="finsyncR">
<title>Calculating Abundances, Raw Counts, and Rarefying Raw Counts • finsyncR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calculating Abundances, Raw Counts, and Rarefying Raw Counts">
<meta property="og:description" content="finsyncR">
<meta property="og:image" content="https://usepa.github.io/finsyncR/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-P48H117T55"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-P48H117T55');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">finsyncR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/BackCalculation.html">Calculating Abundances, Raw Counts, and Rarefying Raw Counts</a>
    <a class="dropdown-item" href="../articles/GettingStarted.html">Getting Started with finsyncR</a>
    <a class="dropdown-item" href="../articles/Metadata.html">Metadata</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Calculating Abundances, Raw Counts, and Rarefying Raw Counts</h1>
            
      
      
      <div class="d-none name"><code>BackCalculation.Rmd</code></div>
    </div>

    
    
<p>In specific instances, users may want to generate datasets with
abundances or raw counts of organisms. At this time, the
<code><a href="../reference/getInvertData.html">getInvertData()</a></code> function does not inherently provide for
these types of data. However, sample abundances and raw counts can be
back-calculated from density values (see Figure 2 in the “Getting
Started” vignette). This vignette provides the code for this back
calculation, as well as code to rarefy count data.</p>
<p>Read in the necessary packages and generate the invertebrate density
dataset.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>; <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://usepa.github.io/finsyncR/">finsyncR</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">##Generate invertebrate dataset</span></span>
<span><span class="va">i2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getInvertData.html">getInvertData</a></span><span class="op">(</span>  dataType <span class="op">=</span> <span class="st">"density"</span>,</span>
<span>                      taxonLevel <span class="op">=</span> <span class="st">"Mixed"</span>,</span>
<span>                      taxonFix <span class="op">=</span> <span class="st">"lump"</span>,</span>
<span>                      agency <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"USGS"</span>,<span class="st">"EPA"</span><span class="op">)</span>,</span>
<span>                      lifestage <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                      rarefy <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                      sharedTaxa <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                      seed <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                      boatableStreams <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>Since density is sample abundance / Area sampled, we can calculate
sample abundance by multiplying density values by the area sampled.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">i2_Abundance</span> <span class="op">&lt;-</span> <span class="va">i2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span>.cols <span class="op">=</span> <span class="op">!</span><span class="op">(</span><span class="va">Agency</span><span class="op">:</span><span class="va">Gen_ID_Prop</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span> <span class="va">.</span> <span class="op">*</span> <span class="va">AreaSampTot_m2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then, since sample abundance is Raw Count * (1 / Proportion of the
sample identified [<code>PropID</code>]), we can calculate raw count
values by multiplying sample abundance values by <code>PropID</code>
(proportion of the sample identified). Here we include the
<code><a href="https://rdrr.io/r/base/Round.html" class="external-link">round()</a></code> function, because of rounding in the calculation of
density, many raw count values are not integers. So, including
<code><a href="https://rdrr.io/r/base/Round.html" class="external-link">round()</a></code> provides the integer value of the raw counts.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">i2_RawCount</span> <span class="op">&lt;-</span> <span class="va">i2_Abundance</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span>.cols <span class="op">=</span> <span class="op">!</span><span class="op">(</span><span class="va">Agency</span><span class="op">:</span><span class="va">Gen_ID_Prop</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">.</span> <span class="op">*</span> <span class="va">PropID</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Following the generation of raw counts for the dataset, users can
generate rarefies count data. Notes on specific portions of the code are
provided. Two importance pieces of information to note: 1) The following
code should only be used when <code>taxonLevel = "Mixed"</code>, because
this is the only way to ensure that no specimen are dropped within a
sample. 2) The following code will take considerable time to complete,
as there are 16,579,059 rows of unique taxa within samples in the full
dataset. It is estimated that for the full dataset, the code will take
~30 minutes to rarefy counts.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##users can specify the rarefaction level</span></span>
<span><span class="va">rarefyCount</span> <span class="op">=</span> <span class="fl">300</span></span>
<span></span>
<span><span class="co">##set seed for consistent output</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">##run the code to rarefy raw counts to the "rarefyCount" level</span></span>
<span><span class="va">i2_RarefiedRawCount</span> <span class="op">&lt;-</span> <span class="va">i2_RawCount</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span><span class="co">#change to long format for ease</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="op">!</span><span class="op">(</span><span class="va">Agency</span><span class="op">:</span><span class="va">Gen_ID_Prop</span><span class="op">)</span>,</span>
<span>               values_to <span class="op">=</span> <span class="st">"RawCount"</span>,</span>
<span>               names_to <span class="op">=</span> <span class="st">"Taxa"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">Agency</span><span class="op">:</span><span class="va">Gen_ID_Prop</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span><span class="co">#calculate sample specimen counts</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>SampleCount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">RawCount</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span><span class="co">#remove all samples with few than rarefyCount specimen</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">SampleCount</span> <span class="op">&gt;=</span> <span class="va">rarefyCount</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">SampleCount</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">Agency</span><span class="op">:</span><span class="va">Taxa</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span><span class="co">#for each taxa within a sample, make RawCount number of replicate rows,</span></span>
<span><span class="co">#such that the number of specimen for a given taxa is represented by a row of data</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, times<span class="op">=</span><span class="va">RawCount</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">Agency</span><span class="op">:</span><span class="va">Gen_ID_Prop</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span><span class="co">#for each sample, randomly select rarefyCount number of rows</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">rarefyCount</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">Agency</span><span class="op">:</span><span class="va">Taxa</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span><span class="co">#for each taxa within a sample, generate the new rarefied counts (number of</span></span>
<span><span class="co">#rows after resampling)</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>RawCount <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span><span class="co">#slice to just 1 row of data for each taxa within a sample, as the RawCounts</span></span>
<span><span class="co">#now contain the rarefied counts</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span><span class="co">#pivot back to a wide format and fill in NAs with 0s</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">Agency</span><span class="op">:</span><span class="va">Gen_ID_Prop</span>,</span>
<span>              names_from <span class="op">=</span> <span class="st">"Taxa"</span>,</span>
<span>              values_from <span class="op">=</span> <span class="st">"RawCount"</span>,</span>
<span>              values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Michael Mahon, Samantha Rumschlag, Devin Jones, Ryan Hill, Terry Brown, Ethan Brown, Stefan Kunz.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
